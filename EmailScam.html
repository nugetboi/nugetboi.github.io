<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Email Scam + Red AI Monster</title>
<style>
/* ... your CSS stays exactly the same ... */
body {
    margin: 0;
    background: #000;
    overflow: hidden;
    font-family: Arial, Helvetica, sans-serif;
    color: white;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}

.frame {
    width: 960px;
    height: 540px;
    border: 2px solid white;
    position: relative;
    overflow: hidden;
    box-sizing: border-box;
    transition: opacity 1.5s ease;
}

/* FADE OUT EFFECT */
.fade-out {
    opacity: 0;
}

/* ================= BACKGROUND VIDEO ================= */
.background-video {
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    object-fit: cover;
    filter: brightness(0.7) contrast(1.1);
    z-index:0;
}

/* ================= SCREEN FLASH ================= */
.flash-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    opacity: 0;
    pointer-events: none;
    z-index: 999;
}

.flash-active {
    animation: flash 0.4s ease-out forwards;
}

@keyframes flash {
    0% {opacity: 1;}
    100% {opacity: 0;}
}

/* Dialogue Box */
.dialogue-box {
    width: 900px;
    min-height: 90px;
    background: #2a2a2a;
    border: 2px solid white;
    border-radius: 25px;
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    padding: 15px 20px;
    box-sizing: border-box;
    color: white;
    font-size: 16px;
    display: flex;
    flex-direction: column;
    cursor: pointer;
    z-index: 15;
}

.speaker-name {
    font-weight: bold;
    text-decoration: underline;
    margin-bottom: 5px;
}

.dialogue-text {
    flex: 1;
    position: relative;
    overflow: hidden;
    white-space: pre-wrap;
    padding-right: 80px;
}

.typing::after {
    content: '|';
    animation: blink 0.7s infinite;
    margin-left: 2px;
}

.click-hint {
    position: absolute;
    bottom: 10px;
    right: 15px;
    font-size: 14px;
    color: #ccc;
    opacity: 0.8;
    display: none;
}

@keyframes blink {
    0%,50%,100% {opacity:1;}
    25%,75% {opacity:0;}
}

/* ==================== RED AI CREATURE ==================== */
#creature-container {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 480px;
    height: 480px;
    transform: translate(-50%, -50%) scale(0.5);
    z-index: 10;
    opacity: 0;
    transition: all 0.5s ease;
}

#creature-container.fullscreen {
    transform: translate(-50%, -50%) scale(1.5);
    opacity: 1;
}

@keyframes monsterJitter {
    0% { transform: translate(-50%, -50%) rotate(0deg) scale(1.5); }
    50% { transform: translate(-50%, -50%) rotate(3deg) scale(1.58); }
    100% { transform: translate(-50%, -50%) rotate(0deg) scale(1.5); }
}

/* Wings + Body */
.wing-left-1{position:absolute;width:110px;height:160px;background:linear-gradient(135deg, rgba(255,0,0,0.5), rgba(180,0,0,0.2));clip-path: polygon(30% 0%,100% 30%,90% 100%,0% 95%);top:140px;left:50px;transform-origin:right center;animation: wing-flap-l1 2s ease-in-out infinite;filter:drop-shadow(0 0 15px #f00);}
.wing-left-2{position:absolute;width:95px;height:120px;background:linear-gradient(125deg, rgba(255,50,50,0.3), rgba(180,0,0,0.3));clip-path: polygon(40% 5%,100% 25%,85% 100%,10% 90%);top:165px;left:35px;transform-origin:right center;animation: wing-flap-l2 2.3s ease-in-out infinite;filter:drop-shadow(0 0 20px #f00);}
.wing-left-3{position:absolute;width:80px;height:100px;background:linear-gradient(130deg, rgba(220,0,0,0.35), rgba(255,50,50,0.25));clip-path: polygon(35% 10%,100% 35%,80% 100%,5% 85%);top:180px;left:20px;transform-origin:right center;animation: wing-flap-l3 2.6s ease-in-out infinite;filter:drop-shadow(0 0 18px #f55);}
.wing-right-1{position:absolute;width:100px;height:150px;background:linear-gradient(225deg, rgba(255,0,0,0.35), rgba(180,0,0,0.25));clip-path: polygon(0% 30%,70% 0%,100% 95%,10% 100%);top:140px;right:50px;transform-origin:left center;animation: wing-flap-r1 2.1s ease-in-out infinite;filter:drop-shadow(0 0 15px #f00);}
.wing-right-2{position:absolute;width:85px;height:130px;background:linear-gradient(235deg, rgba(255,50,50,0.3), rgba(180,0,0,0.3));clip-path: polygon(0% 25%,60% 5%,90% 90%,15% 100%);top:160px;right:35px;transform-origin:left center;animation: wing-flap-r2 2.4s ease-in-out infinite;filter:drop-shadow(0 0 20px #f00);}
.wing-right-3{position:absolute;width:75px;height:110px;background:linear-gradient(230deg, rgba(220,0,0,0.4), rgba(255,50,50,0.2));clip-path: polygon(0% 35%,65% 10%,95% 85%,20% 100%);top:180px;right:20px;transform-origin:left center;animation: wing-flap-r3 2.7s ease-in-out infinite;filter:drop-shadow(0 0 18px #f55);}

/* Envelope */
#envelope{position:absolute;width:240px;height:160px;left:50%;top:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#440000,#880000);border:4px solid #000;box-shadow:0 0 20px rgba(255,0,0,0.5);animation: envelope-pulse 2s ease-in-out infinite;}
@keyframes envelope-pulse{0%,100%{box-shadow:0 0 20px rgba(255,0,0,0.5);}50%{box-shadow:0 0 40px rgba(255,0,0,0.8);}}

/* Eyes */
.eye{position:absolute;width:40px;height:40px;background: radial-gradient(circle,#fff 20%,#f00 40%,#000 60%);border-radius:50%;top:50%;transform:translateY(-50%);box-shadow:0 0 15px #f00;overflow:hidden;}
.eye-left{left:35px;}
.eye-right{right:35px;}
.pupil{position:absolute;width:12px;height:12px;background:#000;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%);animation: blink-eye 3s infinite;}
@keyframes blink-eye{0%,10%,90%,100%{transform:translate(-50%,-50%) scaleY(1);}45%,55%{transform:translate(-50%,-50%) scaleY(0.1);}}

/* Mouth */
#mouth{position:absolute;width:80px;height:25px;top:50%;left:50%;transform:translate(-50%,-50%);overflow:hidden;}
.teeth{position:absolute;bottom:0;width:100%;height:16px;background:linear-gradient(to right,transparent 0%,transparent 8%,#fff 8%,#fff 17%,transparent 17%,transparent 25%,#fff 25%,#fff 34%,transparent 34%,transparent 42%,#fff 42%,#fff 51%,transparent 51%,transparent 59%,#fff 59%,#fff 68%,transparent 68%,transparent 76%,#fff 76%,#fff 85%,transparent 85%,transparent 100%);animation: teeth-snap 0.5s ease-in-out infinite;}
@keyframes teeth-snap{0%,100%{transform:translateY(0);}50%{transform:translateY(-3px);}}

/* Talking indicator */
.speaking-indicator{position:absolute;bottom:-28px;left:50%;transform:translateX(-50%);color:#f00;font-family:monospace;font-size:12px;text-shadow:0 0 8px #f55;animation:text-blink 1s infinite;}
@keyframes text-blink{0%,100%{opacity:1;}50%{opacity:0;}}
</style>
</head>
<body>

<div class="frame" id="frame">
<iframe id="bgmFrame" src="bgm.html" style="display:none;"></iframe>
    <video class="background-video" autoplay muted loop playsinline preload="auto">
        <source src="walking corridor.mp4" type="video/mp4">
    </video>

    <div class="flash-overlay" id="flash"></div>

    <div class="dialogue-box" id="dialogue">
        <span class="speaker-name" id="speaker">You</span>
        <span class="dialogue-text typing" id="dialogueText"></span>
        <span class="click-hint" id="clickHint">Click to continue →</span>
    </div>

    <div id="creature-container">
        <div class="wing-left-1"></div>
        <div class="wing-left-2"></div>
        <div class="wing-left-3"></div>
        <div class="wing-right-1"></div>
        <div class="wing-right-2"></div>
        <div class="wing-right-3"></div>

        <div id="envelope">
            <div class="eye eye-left"><div class="pupil"></div></div>
            <div class="eye eye-right"><div class="pupil"></div></div>
            <div id="mouth"><div class="teeth"></div></div>
            <div class="speaking-indicator">[ TRANSMITTING ]</div>
        </div>
    </div>
</div>

<audio id="warble" src="3M@ talking.mp3"></audio>
<audio id="jumpscare" src="squeaky-jumpscare-81079.mp3"></audio>

<script>
// Helper to safely message the BGM iframe
  function bgmSend(msg) {
    const f = document.getElementById("bgmFrame");
    if (f && f.contentWindow) f.contentWindow.postMessage(msg, "*");
  }

  // IMPORTANT:
  // Autoplay rules: BGM can only start after the user interacts at least once.
  // So we "arm" it here. The first click/tap/keydown will trigger PLAY_BGM.
  function unlockAndPlayBgmOnce() {
    bgmSend("PLAY_BGM");
    document.removeEventListener("pointerdown", unlockAndPlayBgmOnce);
    document.removeEventListener("keydown", unlockAndPlayBgmOnce);
  }

  document.addEventListener("pointerdown", unlockAndPlayBgmOnce, { once: true });
  document.addEventListener("keydown", unlockAndPlayBgmOnce, { once: true });

  // Optional: If you want BGM to ALWAYS try to play when a page loads (after it's already unlocked),
  // uncomment the next line:
  // window.addEventListener("load", () => bgmSend("PLAY_BGM"));

const dialogueText = document.getElementById("dialogueText");
const speakerEl = document.getElementById("speaker");
const clickHint = document.getElementById("clickHint");
const creature = document.getElementById("creature-container");
const flash = document.getElementById("flash");
const warble = document.getElementById("warble");
const jumpscare = document.getElementById("jumpscare");
const frame = document.getElementById("frame");
const dialogueBox = document.getElementById("dialogue");

const lines = [
    {speaker:"You", text:"Hmm… that robot mentioned something about minions...?"},
    {speaker:"3M@", text:"BOO, I am 3M@, your not so friendly neighborhood email scammer."},
    {speaker:"3M@", text:"Did you know that Generative AI has helped me a ton!"},
    {speaker:"3M@", text:"Thanks to Generative AI, grammar mistakes are now harder to spot MUAHAHAHA!"},
    {speaker:"3M@", text:"Anyway, to beat me you have to sort 6 emails into Safe or Suspicious folders."},
    {speaker:"3M@", text:"If you manage to sort through them all in time, I will admit defeat..."},
    {speaker:"3M@", text:"But if you fail, well... good luck!"}
];

let lineIndex = 0;
let charIndex = 0;
let isTyping = true;
let typingInterval = null;
let canClick = false;
let audioUnlocked = false;
let jumpscareDone = false;
let jumpscarePlaying = false;

/* ---- GLOBAL AUDIO UNLOCK ---- */
function unlockAudio() {
    if (audioUnlocked) return;
    audioUnlocked = true;

    [jumpscare, warble].forEach(a=>{
        a.volume = 1;
        a.play().then(()=>{
            a.pause();
            a.currentTime = 0;
        }).catch(()=>{});
    });
}

document.addEventListener("pointerdown", unlockAudio, { once:true });
document.addEventListener("keydown", unlockAudio, { once:true });

function showClickHint(){ clickHint.style.display="block"; }
function hideClickHint(){ clickHint.style.display="none"; }

function handleVoice(speaker, action){
    if(speaker === "3M@" && action === "start"){
        warble.loop = true;
        warble.currentTime = 0;
        warble.play().catch(()=>{});
    } 
    if(action === "stop"){
        warble.pause();
        warble.currentTime = 0;
    }
}

function fadeToEmailGame(){
    frame.classList.add("fade-out");
    setTimeout(()=> window.location.href = "EmailGame.html", 1500);
}

/* NEW: central helper so last line always leads to next page */
function maybeGoToEmailGame() {
    if (lineIndex === lines.length - 1) {
        canClick = false;
        hideClickHint();
        setTimeout(() => fadeToEmailGame(), 1200);
    }
}

function typeLine(){
    const line = lines[lineIndex];

    dialogueText.innerHTML = "";
    hideClickHint();
    speakerEl.textContent = line.speaker;

    charIndex = 0;
    isTyping = true;
    canClick = false;
    dialogueText.classList.add('typing');

    clearInterval(typingInterval);
    typingInterval = setInterval(()=>{
        if(charIndex < line.text.length){
            dialogueText.innerHTML += line.text.charAt(charIndex);
            charIndex++;

            // Start warble once per 3M@ line (after audio unlock)
            if(line.speaker === "3M@" && charIndex === 1 && audioUnlocked){
                handleVoice("3M@", "start");
            }

        } else {
            clearInterval(typingInterval);
            isTyping = false;
            dialogueText.classList.remove('typing');

            if(line.speaker === "3M@"){
                handleVoice("3M@","stop");
            }

            // Use helper: if last line, go to game; else normal click-to-continue
            if(lineIndex === lines.length - 1){
                maybeGoToEmailGame();
            } else {
                canClick = true;
                showClickHint();
            }
        }
    },30);
}

/* CLICK HANDLER */
dialogueBox.addEventListener("click", ()=>{

    const line = lines[lineIndex];

    // If still typing, finish instantly
    if(isTyping){
        clearInterval(typingInterval);
        dialogueText.innerHTML = line.text;
        dialogueText.classList.remove('typing');
        isTyping = false;

        if(line.speaker === "3M@"){
            handleVoice("3M@","stop");
        }

        // If this was the last line, go to game now
        if(lineIndex === lines.length - 1){
            maybeGoToEmailGame();
        } 
        // For other lines, show click hint (except line 0 which leads to jumpscare)
        else if(lineIndex !== 0){
            canClick = true;
            showClickHint();
        }
        return;
    }

    // If we can't click yet (e.g. during jumpscare), ignore
    if(!canClick && !(lineIndex === 0 && !jumpscareDone)) return;

    // SPECIAL CASE: after first line, trigger jumpscare on click
    if(lineIndex === 0 && !jumpscareDone){
        canClick = false;
        hideClickHint();
        jumpscarePlaying = true;

        // Bring monster in + play jumpscare WITH sound (inside click)
        creature.classList.add('fullscreen');
        creature.style.animation = "monsterJitter 0.6s ease-in-out 3";

        flash.classList.add("flash-active");
        jumpscare.currentTime = 0;
        jumpscare.play().catch(()=>{});

        setTimeout(()=> flash.classList.remove("flash-active"), 400);

        setTimeout(()=>{
            creature.style.animation = "";
            jumpscareDone = true;
            jumpscarePlaying = false;
            // Now go to next line (3M@ appears)
            lineIndex++;
            typeLine();
        }, 1800);

        return;
    }

    // Normal progression for other lines
    if(lineIndex < lines.length - 1){
        lineIndex++;
        typeLine();
    } else {
        // safety: if somehow clicked on last line after it's done
        maybeGoToEmailGame();
    }
});

window.onload = typeLine;
</script>
</body>
</html>
